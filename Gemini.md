# プロジェクト引継書：日本語タイピング練習 Web アプリ

## 1. プロジェクト概要

本プロジェクトは、正確性を重視した日本語タイピング練習 Web アプリケーションのプロトタイプです。ユーザーは画面に表示される日本語の文章をローマ字で入力し、その入力の正確性と速度が評価されます。ミスタイプが発生した際には即座にフィードバックが提供され、正しい入力が完了するまで次の文字に進めない厳格な入力制御が特徴です。これにより、ユーザーは正確なタイピングスキルを習得することを目指します。

## 2. 現在の主要機能と画面構成

アプリケーションは以下の主要な画面と機能で構成されています。

### 2.1. トップ画面 (`src/app/page.tsx`)

- アプリケーションの簡単な説明が表示されます。
- タイピング練習を開始するための「タイピングを開始する」ボタンが配置されています。
- ヘッダー部分に、ログイン状態に応じて「ログイン」ボタン、またはユーザー情報、「成績履歴」リンク、「ログアウト」ボタンが表示されます。

### 2.2. タイピング練習画面 (`src/app/typing/page.tsx`)

- `TypingGame` コンポーネントが主要なタイピングロジックとユーザーインターフェースを提供します。
- **入力ロジック**:
  - 表示された日本語の仮名（ひらがな）をローマ字で入力します。
  - 正しいローマ字入力が完了すると、自動的に次の仮名へとカーソルが移動します。
  - 不正な入力があった場合、エラー表示（文字が赤色になるなど）が行われ、ユーザーが正しいローマ字を入力するまで次の文字への進行がブロックされます。
  - 日本語特有のローマ字入力ルール（例: 「ん」の `n` / `nn` / `n'`、促音「っ」の次の子音の重複入力など）に対応していないので、今後対応させたい。
  - ユーザーが現在入力しているローマ字のバッファが画面上に表示されます。
  - 正しく仮名を入力し終えた際、その文字が一時的に黄色にフラッシュし、視覚的なフィードバックを提供します。
- **統計情報**:
  - `totalKeystrokes` (総打鍵数) と `correctKeystrokes` (正解打鍵数) がリアルタイムでカウントされます。
  - `correctKanaUnits` (正解仮名数) がカウントされます。
  - `mistakes` 配列に、ミスタイプに関する詳細情報（ミスした文字、期待されたローマ字、実際の入力、打鍵されたキー、仮名のインデックスなど）が記録されます。
- **操作性**:
  - `Esc` キーを押すことで、いつでもトップ画面に戻ることができます。
- **視覚補助**:
  - `OnScreenKeyboard` コンポーネントが表示され、ユーザーが最後に打鍵したキーがハイライト表示されます。

### 2.3. 結果画面 (`src/app/result/page.tsx`)

- `ResultDisplay` コンポーネントがタイピング練習の結果を表示します。
- タイピング結果は `localStorage` からロードされ、以下の情報が表示されます。
  - **正確性**: 正解打鍵数と総打鍵数に基づいたパーセンテージ。
  - **タイピング速度**: WPM (Words Per Minute) 形式で表示されます。
  - **ミスタイプ箇所一覧**: どの文字でミスタイプが発生したかの詳細なリスト。
  - **ミス傾向分析 (文字別)**: 各文字ごとのミス回数とパターンが集計され、ユーザーが苦手とするキーや文字の傾向を視覚的に把握できます。

### 2.4. 成績履歴ページ (`src/app/history/page.tsx`)

- ログインしているユーザーが、過去のタイピング成績を振り返るためのページです。
- **成績推移グラフ**: `recharts`を用いて、WPM と正解率の推移を折れ線グラフで可視化します。
- **成績一覧テーブル**: 過去の全成績（実施日時、WPM、正解率、ミス回数など）を表形式で表示します。

### 2.5. ログイン機能

今後のパーソナライズ機能（成績保存、苦手分析など）の基盤として、ユーザー認証機能が実装されています。ログインしているユーザーのタイピング結果は、自動的にデータベースに保存されます。

- **認証プロバイダー**:
  - GitHub
  - Google
- **ユーザーフロー**:
  1.  トップページ右上の「ログイン」ボタンをクリックすると、ログイン選択ページ (`/login`) に遷移します。
  2.  ログインページで、GitHub または Google のボタンを選択し、各サービスの OAuth 認証フローを開始します。
  3.  認証が成功するとトップページにリダイレクトされ、ヘッダーにユーザー名とアバター画像、そして「ログアウト」ボタンが表示されます。
  4.  ログアウト後、再度ログインする際には、明示的にアカウントを選択するよう促され、意図しない自動ログインを防ぎます。

### 2.6. ログインページ (`src/app/login/page.tsx`)

- 利用可能なログイン方法（GitHub, Google）の一覧がボタンとして表示されます。
- 各ボタンにはサービスのロゴアイコンが表示され、視認性が高められています。

## 3. 技術スタック

- **フレームワーク**: Next.js (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **認証**: NextAuth.js
- **ORM**: Prisma
- **グラフ描画**: recharts

## 4. 主要ファイルと役割

- `public/kana_romaji_map.json`: ひらがなとローマ字の変換ルールを定義した JSON データファイル。
- `src/components/KanaRomajiMap.ts`: `kana_romaji_map.json` をロードし、仮名に対応するローマ字候補を提供するユーティリティ関数群。
- `src/components/OnScreenKeyboard.tsx`: 画面上に仮想キーボードを表示し、ユーザーのキー入力を視覚的にフィードバックするコンポーネント。
- `src/components/TypingGame.tsx`: タイピング練習画面のメインコンポーネント。コアロジックはカスタムフックに抽出されており、主にレンダリングを担当します。
- `src/hooks/useTypingGame.ts`: タイピングゲームのコアロジックをカプセル化したカスタムフック。UI イベントと状態をつなぐ役割に集中しており、具体的な状態管理や API 通信は別ファイルに移管されています。
- `src/utils/typingUtils.ts`: 日本語の文章をタイピング単位（拗音、促音など）に分解するためのヘルパー関数。
- `src/utils/romajiUtils.ts`: ローマ字と仮名の一致判定ロジックを担う純粋関数です。

**認証関連**

- `src/app/api/auth/[...nextauth]/route.ts`: NextAuth.js のバックエンド設定ファイル。認証プロバイダー（GitHub, Google）やデバッグモードなどの設定を定義します。
- `.env.local`: `GITHUB_ID`, `GOOGLE_CLIENT_ID`, `DATABASE_URL` などの認証・接続情報や、`NEXTAUTH_SECRET` などの秘匿情報を格納します。（このファイルはリポジトリに含まれません）
- `src/components/AuthProvider.tsx`: NextAuth.js の `SessionProvider` をラップするクライアントコンポーネント。アプリケーション全体でセッション情報を共有可能にします。
- `src/components/LoginStatus.tsx`: ヘッダーに表示される UI コンポーネント。ログイン状態を監視し、「ログイン」ボタンやユーザー情報・「ログアウト」ボタンを動的に表示します。
- `next.config.js`: 外部ドメイン（GitHub, Google）のアバター画像を `next/image` で表示するためのホスト名を設定します。

**データベース・状態管理・成績履歴関連**

- `prisma/schema.prisma`: Prisma で使用するデータベースのスキーマ（テーブル構造、リレーション）を定義します。
- `src/lib/prisma.ts`: Prisma Client のインスタンスをシングルトンパターンで生成・管理します。
- `src/app/api/typing-results/route.ts`: タイピング結果をデータベースに保存するための API エンドポイントです。
- `src/services/typingResultService.ts`: 結果保存 API の通信ロジックをカプセル化したサービス関数です。
- `src/state/typingGameState.ts`: `useTypingGame`フックで利用する`useReducer`の状態、アクション、reducer 関数を定義します。
- `src/components/HistoryChart.tsx`: `recharts`を使い、成績の推移を折れ線グラフで表示するコンポーネントです。
- `src/components/HistoryTable.tsx`: 過去の成績を表形式で表示するコンポーネントです。

## 5. 拡張予定・将来的な機能

以下の機能は、今後の開発で実装が検討されている項目です。

### 5.1. 認証・ユーザー関連

- **認証プロバイダーの追加**: Twitter など、他の認証プロバイダーの追加。

### 5.2. コース管理・検索機能

- **コースのサムネイル画像設定**: 練習コースにサムネイル画像を選択・アップロードできる機能。
- **練習コースの検索・フィルタリング**: タグ、検索窓、フィルターなどを用いて、練習コースを効率的に検索できる機能。

### 5.3. 苦手分析と練習の最適化 (重要機能)

- **苦手分析の高度化**: オンライン DB を利用し、ユーザーの苦手な指や、特定のキー入力シーケンス（例: 「h」の後に「u」を間違えがちなど）を分析。
- **パーソナライズされたコース推薦**: 分析結果に基づき、ユーザーの弱点を改善できる適切な練習コースを推薦する機能。
- **スコアランキング**: データベースを利用し、ユーザーのタイピングスコアをオンラインでランキング表示する機能。

### 5.4. タイピングゲーム機能の拡張と設定

- **総合スコアの算出と保存**: WPM や正確性から総合的なスコアを算出し、結果画面で表示しデータベースに保存する機能。(例: (正解打鍵数 － ミス打鍵数) ÷ 秒 × 1000)
- **キーボード表示・ハイライト設定**:
  - タイピング画面で仮想キーボードの表示/非表示を切り替えるオプション。(プレイ前に ON/OFF 可能)
  - 仮想キーボード表示時、次に入力すべきキーをハイライトする機能。 (実装済み)
- **運指ガイド機能**:
  - タイピング画面に簡易的な指のイラストを表示し、入力すべきキーに応じて適切な指をハイライトする機能。(実装済み)
- **ミスタイプ時のペナルティカスタマイズ**:
  - ミスタイプ時に派手なアニメーションや効果音を発生させる機能。
  - 上記ペナルティの有無や種類をコース選択時に選択できる機能。
  - **BackSpace キーペナルティ**: ミスタイプした文字数に応じて「BackSpace キー」を押さないと次に進めない機能。(例: ローマ字が成立しない入力 `htw` の場合、3 回の BackSpace が必要だが、`ha`の場合「は」に置き換わるので、1 回で良いなど、厳密に。)
- **超高難易度モード**: ミスすると最初からやり直し（時間はリセットされない）。画面が揺れる、崩れるなど、緊張感を煽る派手な演出を追加。

### 5.5. AI チャットボット連携

- **診断・コース推薦 AI**: Dify などの無料 AI チャットボットを活用し、ユーザーのタイピングスキルを診断し、最適な練習コースを提示する機能。
- **サイト説明・QA 対応 AI**: Dify などの無料 AI チャットボットを活用し、サイトの説明やユーザーからの質問に応答する機能。

### 5.6. UI/UX の改善

- ~~練習中に表示される仮名やローマ字を非表示にできるオプション機能。~~ (実装済み)
- ~~タイピング画面に薄い 10 本の指のイラストを表示し、次に打つべきキーに対応する指をハイライトする機能。~~ (実装済み、運指ガイド機能としてさらに強化予定)
- ~~ローマ字ガイドの表示/非表示や、動的/静的表示（ユーザーの入力スタイルに合わせて変化）を切り替えられる設定機能。~~ (実装済み)

### 5.7. セキュリティ強化

- メール認証機能の追加。
- データベース保護の強化。

## 6. 現在の開発状況 (2025/12/03)

現在の開発は主に以下の点に注力しています。

- **運指ガイド機能**: ユーザーが次に打つべきキーに対応する指を視覚的に表示する運指ガイド機能を実装しました。
- **総合スコアの実装**: ユーザーのパフォーマンスを測る総合スコアの計算と保存機能を実装しました。これにより、将来的なランキング機能や苦手分析の基盤が整いました。
- **コース管理機能の強化**: ユーザーがコースを作成、編集、削除できる機能を実装しました。トップページは EC サイトのようにコースが一覧表示される形式になっています。
- **データベース移行**: コースデータは静的ファイルから SQLite データベースに移行され、API を通じて管理されています。
- **ログイン/認証**: GitHub および Google OAuth による認証機能が実装されており、ユーザーのタイピング結果をデータベースに保存できるようになっています。
- **将来機能の整理**: 今後の開発を円滑に進めるため、検討中の機能や UI 改善案を「5. 拡張予定・将来的な機能」セクションに整理し、詳細化しました。

## 7. データ構造の変更点 (2025/12/03)

- **DB 変更**: `TypingResult` テーブルに `score` カラムを追加しました。
- **API**:
  - `POST /api/typing-results`: スコアを含む結果データを受け入れ、保存するように更新。
  - `GET /api/courses`: コース一覧取得 (プレビュー用テキスト含む)
  - `GET /api/courses/[id]`: コース詳細・全テキスト取得
