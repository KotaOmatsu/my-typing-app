# プロジェクト引継書：日本語タイピング練習Webアプリ

## 1. プロジェクト概要

本プロジェクトは、正確性を重視した日本語タイピング練習Webアプリケーションのプロトタイプです。ユーザーは画面に表示される日本語の文章をローマ字で入力し、その入力の正確性と速度が評価されます。ミスタイプが発生した際には即座にフィードバックが提供され、正しい入力が完了するまで次の文字に進めない厳格な入力制御が特徴です。これにより、ユーザーは正確なタイピングスキルを習得することを目指します。

## 2. 現在の主要機能と画面構成

アプリケーションは以下の主要な画面と機能で構成されています。

### 2.1. トップ画面 (`src/app/page.tsx`)

-   アプリケーションの簡単な説明が表示されます。
-   タイピング練習を開始するための「タイピングを開始する」ボタンが配置されています。
-   ヘッダー部分に、ログイン状態に応じて「ログイン」ボタン、またはユーザー情報、「成績履歴」リンク、「ログアウト」ボタンが表示されます。

### 2.2. タイピング練習画面 (`src/app/typing/page.tsx`)

-   `TypingGame` コンポーネントが主要なタイピングロジックとユーザーインターフェースを提供します。
-   **入力ロジック**:
    -   表示された日本語の仮名（ひらがな）をローマ字で入力します。
    -   正しいローマ字入力が完了すると、自動的に次の仮名へとカーソルが移動します。
    -   不正な入力があった場合、エラー表示（文字が赤色になるなど）が行われ、ユーザーが正しいローマ字を入力するまで次の文字への進行がブロックされます。
    -   日本語特有のローマ字入力ルール（例: 「ん」の `n` / `nn` / `n'`、促音「っ」の次の子音の重複入力など）に対応しています。
    -   ユーザーが現在入力しているローマ字のバッファが画面上に表示されます。
    -   正しく仮名を入力し終えた際、その文字が一時的に黄色にフラッシュし、視覚的なフィードバックを提供します。
-   **統計情報**:
    -   `totalKeystrokes` (総打鍵数) と `correctKeystrokes` (正解打鍵数) がリアルタイムでカウントされます。
    -   `correctKanaUnits` (正解仮名数) がカウントされます。
    -   `mistakes` 配列に、ミスタイプに関する詳細情報（ミスした文字、期待されたローマ字、実際の入力、打鍵されたキー、仮名のインデックスなど）が記録されます。
-   **操作性**:
    -   `Esc` キーを押すことで、いつでもトップ画面に戻ることができます。
-   **視覚補助**:
    -   `OnScreenKeyboard` コンポーネントが表示され、ユーザーが最後に打鍵したキーがハイライト表示されます。

### 2.3. 結果画面 (`src/app/result/page.tsx`)

-   `ResultDisplay` コンポーネントがタイピング練習の結果を表示します。
-   タイピング結果は `localStorage` からロードされ、以下の情報が表示されます。
    -   **正確性**: 正解打鍵数と総打鍵数に基づいたパーセンテージ。
    -   **タイピング速度**: WPM (Words Per Minute) 形式で表示されます。
    -   **ミスタイプ箇所一覧**: どの文字でミスタイプが発生したかの詳細なリスト。
    -   **ミス傾向分析 (文字別)**: 各文字ごとのミス回数とパターンが集計され、ユーザーが苦手とするキーや文字の傾向を視覚的に把握できます。

### 2.4. 成績履歴ページ (`src/app/history/page.tsx`)

- ログインしているユーザーが、過去のタイピング成績を振り返るためのページです。
- **成績推移グラフ**: `recharts`を用いて、WPMと正解率の推移を折れ線グラフで可視化します。
- **成績一覧テーブル**: 過去の全成績（実施日時、WPM、正解率、ミス回数など）を表形式で表示します。

### 2.5. ログイン機能

今後のパーソナライズ機能（成績保存、苦手分析など）の基盤として、ユーザー認証機能が実装されています。ログインしているユーザーのタイピング結果は、自動的にデータベースに保存されます。

-   **認証プロバイダー**:
    -   GitHub
    -   Google
-   **ユーザーフロー**:
    1.  トップページ右上の「ログイン」ボタンをクリックすると、ログイン選択ページ (`/login`) に遷移します。
    2.  ログインページで、GitHubまたはGoogleのボタンを選択し、各サービスのOAuth認証フローを開始します。
    3.  認証が成功するとトップページにリダイレクトされ、ヘッダーにユーザー名とアバター画像、そして「ログアウト」ボタンが表示されます。
    4.  ログアウト後、再度ログインする際には、明示的にアカウントを選択するよう促され、意図しない自動ログインを防ぎます。

### 2.6. ログインページ (`src/app/login/page.tsx`)

-   利用可能なログイン方法（GitHub, Google）の一覧がボタンとして表示されます。
-   各ボタンにはサービスのロゴアイコンが表示され、視認性が高められています。

## 3. 技術スタック

-   **フレームワーク**: Next.js (App Router)
-   **言語**: TypeScript
-   **スタイリング**: Tailwind CSS
-   **認証**: NextAuth.js
-   **ORM**: Prisma
-   **グラフ描画**: recharts

## 4. 主要ファイルと役割

-   `public/kana_romaji_map.json`: ひらがなとローマ字の変換ルールを定義したJSONデータファイル。
-   `src/components/KanaRomajiMap.ts`: `kana_romaji_map.json` をロードし、仮名に対応するローマ字候補を提供するユーティリティ関数群。
-   `src/components/OnScreenKeyboard.tsx`: 画面上に仮想キーボードを表示し、ユーザーのキー入力を視覚的にフィードバックするコンポーネント。
-   `src/components/TypingGame.tsx`: タイピング練習画面のメインコンポーネント。コアロジックはカスタムフックに抽出されており、主にレンダリングを担当します。
-   `src/hooks/useTypingGame.ts`: タイピングゲームのコアロジックをカプセル化したカスタムフック。UIイベントと状態をつなぐ役割に集中しており、具体的な状態管理やAPI通信は別ファイルに移管されています。
-   `src/utils/typingUtils.ts`: 日本語の文章をタイピング単位（拗音、促音など）に分解するためのヘルパー関数。
-   `src/utils/romajiUtils.ts`: ローマ字と仮名の一致判定ロジックを担う純粋関数です。

**認証関連**
-   `src/app/api/auth/[...nextauth]/route.ts`: NextAuth.jsのバックエンド設定ファイル。認証プロバイダー（GitHub, Google）やデバッグモードなどの設定を定義します。
-   `.env.local`: `GITHUB_ID`, `GOOGLE_CLIENT_ID`, `DATABASE_URL` などの認証・接続情報や、`NEXTAUTH_SECRET` などの秘匿情報を格納します。（このファイルはリポジトリに含まれません）
-   `src/components/AuthProvider.tsx`: NextAuth.jsの `SessionProvider` をラップするクライアントコンポーネント。アプリケーション全体でセッション情報を共有可能にします。
-   `src/components/LoginStatus.tsx`: ヘッダーに表示されるUIコンポーネント。ログイン状態を監視し、「ログイン」ボタンやユーザー情報・「ログアウト」ボタンを動的に表示します。
-   `next.config.js`: 外部ドメイン（GitHub, Google）のアバター画像を `next/image` で表示するためのホスト名を設定します。

**データベース・状態管理・成績履歴関連**
-   `prisma/schema.prisma`: Prismaで使用するデータベースのスキーマ（テーブル構造、リレーション）を定義します。
-   `src/lib/prisma.ts`: Prisma Clientのインスタンスをシングルトンパターンで生成・管理します。
-   `src/app/api/typing-results/route.ts`: タイピング結果をデータベースに保存するためのAPIエンドポイントです。
-   `src/services/typingResultService.ts`: 結果保存APIの通信ロジックをカプセル化したサービス関数です。
-   `src/state/typingGameState.ts`: `useTypingGame`フックで利用する`useReducer`の状態、アクション、reducer関数を定義します。
-   `src/components/HistoryChart.tsx`: `recharts`を使い、成績の推移を折れ線グラフで表示するコンポーネントです。
-   `src/components/HistoryTable.tsx`: 過去の成績を表形式で表示するコンポーネントです。

## 5. 拡張予定・将来的な機能

以下の機能は、今後の開発で実装が検討されている項目です。

-   **ログイン機能**:
    -   ~~GoogleやGitHubなどのOAuthプロバイダーを利用したユーザー認証機能。~~ (実装済み)
    -   他の認証プロバイダー（Twitterなど）の追加。
-   **苦手分析と練習文の最適化**:
    -   ~~ログインユーザーごとにタイピング結果をデータベースに保存する。~~ (実装済み)
    -   ~~過去の成績をグラフや図で可視化する機能。~~ (一部実装済み)
    -   オンラインDBを利用し、ユーザーの苦手な指や単語を分析し、それを改善できる練習文章を誘導する機能(PythonとSQLを使う予定)。
-   **スコアランキング**: データベースを利用し、ユーザーのタイピングスコアをオンラインでランキング表示する機能。
-   **ユーザーによる練習文投稿機能**:
    -   オンラインデータベースを用いて、ユーザーがオリジナルの練習文章（小説の一節など）をタイトル付きで投稿・共有できる機能。
    -   トップページはECサイトの商品一覧のように、公式およびユーザー投稿の練習コース（文章セット）が並ぶ形式にする。
    -   各コースを選択後、詳細確認と設定（ガイド表示など）を行ってからスタートするフローを採用。
    -   現状は「吾輩は猫である」などのサンプル文章のみが利用可能。
-   **練習文章の拡張と表示改善**:
    -   ~~練習文章を漢字やカタカナにも対応させる。~~ (実装済み)
    -   ~~現在入力すべき仮名の下に、対応するローマ字候補を表示するUIを追加。~~ (実装済み)
    -   ~~ローマ字ガイドの表示/非表示や、動的/静的表示（ユーザーの入力スタイルに合わせて変化）を切り替えられる設定機能。~~ (実装済み)
-   **ペナルティのカスタマイズ**:
    -   ユーザーがミスタイプ時のペナルティの種類（例: 入力ブロック、警告のみなど）を選択できる機能。
    -   **超高難易度モード**: ミスすると最初からやり直し（時間はリセットされない）。画面が揺れる、崩れるなど、緊張感を煽る派手な演出を追加。
-   **UI/UXの改善**:
    -   ~~練習中に表示される仮名やローマ字を非表示にできるオプション機能。~~ (実装済み)
    -   タイピング画面に薄い10本の指のイラストを表示し、次に打つべきキーに対応する指をハイライトする機能。
